<!DOCTYPE html>
<html lang="en">
<head>
	<title>ZAP Test Server</title>
	<link href="/tutorial.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div class="roundContainer">
	<h1>Enter TOTP Passcode </h1>
	
	<div id="result"></div>

	<form>
	<table style="border: none;">
	<tr>
		<td>TOTP Passcode:</td>
		<td><input id="totp" name="totp" type="text"></td>
	</tr>
	<tr>
		<td></td>
		<td><button id="submit" type="button" value="submit" onclick="submitTOTP();">Submit</button></td>
	</tr>
	</table>
	</form>
	<p>
	Test credentials:
	<ul>
		<li>totp = 123456
	</ul>
	</p>
</div>
<script>

function submitTOTP() {
	// Make the TOTP verification request
	let failedAttempts = parseInt(sessionStorage.getItem("failedAttempts")) || 0;
	var xhr = new XMLHttpRequest();
	var url = "user";
	xhr.open("POST", url, true);
	xhr.setRequestHeader("Authorization", sessionStorage.getItem("accesstoken"));
	xhr.setRequestHeader("Content-Type", "application/json");
	xhr.onreadystatechange = function () {
	    if (xhr.readyState === 4 && xhr.status === 200) {
	        var json = JSON.parse(xhr.responseText);
	        if (json.result === "OK") {
				sessionStorage.removeItem("failedAttempts"); 
	        	window.location.replace("home.html");
	        } else {
	        	failedAttempts++;
				sessionStorage.setItem("failedAttempts", failedAttempts);
            	if (failedAttempts >= 3) {
            		// Lock the account
            		const h3 = document.createElement("h3");
            		const textNode = document.createTextNode("Account locked due to too many failed attempts.");
            		h3.appendChild(textNode);
            		document.getElementById("result").appendChild(h3);
            		document.getElementById("submit").disabled = true; a
            	} else {
            		const h3 = document.createElement("h3");
            		const textNode = document.createTextNode("TOTP incorrect");
            		h3.appendChild(textNode);
            		document.getElementById("result").appendChild(h3);
            	}
	        }
	    }
	};
	var data = JSON.stringify({
		"code": document.getElementById("totp").value
		
	});
	xhr.send(data);
}

document.getElementById('totp').onkeydown = function(e){
    if (e.keyCode == 13) {
        // Handle return key
        submitTOTP();
    }
};

</script>
</body>
</html>